# Example command line: ansible-playbook -i "fedora@10.16.18.218," devstack.yml

---
- hosts: all
  gather_facts: no

  vars:
      devstack_dir: ~/devstack
      dotfiles_dir: ~/dotfiles

  tasks:
    - name: upgrade all packages
      sudo: yes
      yum: name=* state=latest

    - name: install packstack repos
      sudo: yes
      yum: pkg=http://rdo.fedorapeople.org/rdo-release.rpm state=installed

    - name: Install packages
      sudo: yes
      yum: name={{ item }}
      with_items:
          - git
          - vim-enhanced
          - ruby
          - ack
          - httpie
          - mosh
          - git-review
          # - openstack-packstack

    - name: Set up authorized_keys for the deploy user
      authorized_key: user=fedora
                      key="{{ item }}"
      with_file:
        - public_keys/lappy.pub
        - public_keys/work.pub

    - name: checkout devstack
      git: repo=https://github.com/openstack-dev/devstack.git
           dest={{ devstack_dir }}

    - name: checkout dotfiles
      git: repo=https://github.com/jamielennox/dotfiles.git
           dest={{ dotfiles_dir }}
           recursive=yes
           accept_hostkey=True

    - name: create dotfile links
      file: src={{ dotfiles_dir }}/{{ item }}
            dest=~/.{{ item }}
            state=link
      with_items:
        - gitconfig
        - gitignore
        - vim
        - ackrc

    - name: copy local.conf
      copy: src=local.conf
            dest={{ devstack_dir }}/local.conf

    - name: disable selinux
      sudo: yes
      selinux: state=disabled

    - name: tty-less sudo
      sudo: yes
      lineinfile: dest=/etc/sudoers
                  state=absent
                  regexp='^Defaults(\s+)requiretty(\s*)$'
                  validate='visudo -cf %s'
